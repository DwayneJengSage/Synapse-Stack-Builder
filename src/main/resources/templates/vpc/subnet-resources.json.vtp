#foreach( $subnetGroup in $subnetGroups )
	,
	"${subnetGroup.color}PublicNetworkAcl": {
		"Type": "AWS::EC2::NetworkAcl",
		"Properties": {
			"VpcId": {
				"Ref": "VPC"
			},
			"Tags": [
				{
					"Key": "Application",
					"Value": {
						"Ref": "AWS::StackName"
					}
				},
				{
					"Key": "Name",
					"Value": "${subnetGroup.color}Public"
				}
			]
		}
	},
	"${subnetGroup.color}InboundPublicNetworkAclEntry": {
		"Type": "AWS::EC2::NetworkAclEntry",
		"Properties": {
			"NetworkAclId": {
				"Ref": "${subnetGroup.color}PublicNetworkAcl"
			},
			"RuleNumber": "100",
			"Protocol": "-1",
			"RuleAction": "allow",
			"Egress": "false",
			"CidrBlock": "0.0.0.0/0",
			"PortRange": {
				"From": "0",
				"To": "65535"
			}
		}
	},
	"${subnetGroup.color}OutboundPublicNetworkAclEntry": {
		"Type": "AWS::EC2::NetworkAclEntry",
		"Properties": {
			"NetworkAclId": {
				"Ref": "${subnetGroup.color}PublicNetworkAcl"
			},
			"RuleNumber": "100",
			"Protocol": "-1",
			"RuleAction": "allow",
			"Egress": "true",
			"CidrBlock": "0.0.0.0/0",
			"PortRange": {
				"From": "0",
				"To": "65535"
			}
		}
	},
	"${subnetGroup.color}PrivateNetworkAcl": {
		"Type": "AWS::EC2::NetworkAcl",
		"Properties": {
			"VpcId": {
				"Ref": "VPC"
			},
			"Tags": [
				{
					"Key": "Application",
					"Value": {
						"Ref": "AWS::StackName"
					}
				},
				{
					"Key": "Name",
					"Value": "${subnetGroup.color}Private"
				}
			]
		}
	},
	"${subnetGroup.color}InboundPrivateSameGroupNetworkAclEntry": {
		"Type": "AWS::EC2::NetworkAclEntry",
		"Properties": {
			"NetworkAclId": {
				"Ref": "${subnetGroup.color}PrivateNetworkAcl"
			},
			"RuleNumber": "100",
			"Protocol": "-1",
			"RuleAction": "allow",
			"Egress": "false",
			"CidrBlock": "${subnetGroup.cidr}",
			"PortRange": {
				"From": "0",
				"To": "65535"
			}
		}
	},
	"${subnetGroup.color}InboundPrivateVpnNetworkAclEntry": {
		"Type": "AWS::EC2::NetworkAclEntry",
		"Properties": {
			"NetworkAclId": {
				"Ref": "${subnetGroup.color}PrivateNetworkAcl"
			},
			"RuleNumber": "99",
			"Protocol": "-1",
			"RuleAction": "allow",
			"Egress": "false",
			"CidrBlock": {
                  "Ref": "VpnCidr"
             },
			"PortRange": {
				"From": "0",
				"To": "65535"
			}
		}
	},
	"${subnetGroup.color}OutboundPrivateNetworkAclEntry": {
		"Type": "AWS::EC2::NetworkAclEntry",
		"Properties": {
			"NetworkAclId": {
				"Ref": "${subnetGroup.color}PrivateNetworkAcl"
			},
			"RuleNumber": "100",
			"Protocol": "-1",
			"RuleAction": "allow",
			"Egress": "true",
			"CidrBlock": "0.0.0.0/0",
			"PortRange": {
				"From": "0",
				"To": "65535"
			}
		}
	}
	#foreach ( $subnet in $subnetGroup.subnets )
	,
	"${subnet.name}": {
		"Type": "AWS::EC2::Subnet",
		"Properties": {
			"MapPublicIpOnLaunch": #if( ${subnet.type} == 'Public') true #else false #end,
			"VpcId": {
				"Ref": "VPC"
			},
			"CidrBlock": "${subnet.cidr}",
			"AvailabilityZone": "${subnet.availabilityZone}",
			"Tags": [
				{
					"Key": "Application",
					"Value": {
						"Ref": "AWS::StackName"
					}
				},
				{
					"Key": "Name",
					"Value": "${subnet.name}"
				}
			]
		}
	},
	"${subnet.name}RouteTable": {
		"Type": "AWS::EC2::RouteTable",
		"Properties": {
			"VpcId": {
				"Ref": "VPC"
			},
			"Tags": [
				{
					"Key": "Application",
					"Value": {
						"Ref": "AWS::StackName"
					}
				},
				{
					"Key": "Name",
					"Value": "${subnet.name}"
				}
			]
		}
	},
	"${subnet.name}RouteVPN": {
		"Type": "AWS::EC2::Route",
		"Properties": {
			"RouteTableId": {
				"Ref": "${subnet.name}RouteTable"
			},
			"DestinationCidrBlock": "10.1.0.0/16",
			"VpcPeeringConnectionId": {
				"Ref": "VpcPeeringConnection"
			}
		}
	},
	#if( ${subnet.type} == 'Public')
	"${subnet.name}NATGatwayEIP" : {
		"Type" : "AWS::EC2::EIP",
		"Properties" : {
			"Domain" : "vpc"
		}
	},	
	"${subnet.name}NATGatway" : {
		"DependsOn" : "InternetGatewayAttachment",
		"Type" : "AWS::EC2::NatGateway",
		"Properties" : {
			"AllocationId" : { 
				"Fn::GetAtt" : ["${subnet.name}NATGatwayEIP", "AllocationId"]
			},
			"SubnetId" : { "Ref" : "${subnet.name}"},
			"Tags": [
				{
					"Key": "Application",
					"Value": {
						"Ref": "AWS::StackName"
					}
				},
				{
					"Key": "Name",
					"Value": "${subnet.name}"
				}
			]
		}
	},
	"${subnet.name}PublicRoute": {
		"Type": "AWS::EC2::Route",
		"DependsOn": "InternetGatewayAttachment",
		"Properties": {
			"RouteTableId": {
				"Ref": "${subnet.name}RouteTable"
			},
			"DestinationCidrBlock": "0.0.0.0/0",
			"GatewayId": {
				"Ref": "InternetGateway"
			}
		}
	},
	#else
	"${subnet.name}PrivateRoute": {
		"Type": "AWS::EC2::Route",
		"Properties": {
			"RouteTableId": {
				"Ref": "${subnet.name}RouteTable"
			},
			"DestinationCidrBlock": "0.0.0.0/0",
			"NatGatewayId": {
				"Ref": "${subnet.getPublicSubnetNameInSameZone()}NATGatway"
			}
		}
	},
	#end
	"${subnet.name}RouteTableAssociation": {
		"Type": "AWS::EC2::SubnetRouteTableAssociation",
		"Properties": {
			"SubnetId": {
				"Ref": "${subnet.name}"
			},
			"RouteTableId": {
				"Ref": "${subnet.name}RouteTable"
			}
		}
	},
	"${subnet.name}NetworkAclAssociation": {
		"Type": "AWS::EC2::SubnetNetworkAclAssociation",
		"Properties": {
			"SubnetId": {
				"Ref": "${subnet.name}"
			},
			"NetworkAclId": {
				"Ref": "${subnetGroup.color}${subnet.type}NetworkAcl"
			}
		}
	}
	#end
#end