#if( $kinesisFirehoseStreams )
	,"KinesisFirehoseLogRole":{
		"Type":"AWS::IAM::Role",
		"Properties":{
			"AssumeRolePolicyDocument":{
				"Version":"2012-10-17",
				"Statement":[
					{
						"Sid":"",
						"Effect":"Allow",
						"Principal":{
							"Service":"firehose.amazonaws.com"
						},
						"Action":"sts:AssumeRole",
						"Condition":{
							"StringEquals":{
								"sts:ExternalId":{
									"Ref":"AWS::AccountId"
								}
							}
						}
					}
				]
			},
			"Policies":[
				{
					"PolicyName":"kinesisWriteToS3Policy",
					"PolicyDocument":{
						"Version":"2012-10-17",
						"Statement":[
							{
								"Sid":"",
								"Effect":"Allow",
								"Action":[
									"s3:AbortMultipartUpload",
									"s3:GetBucketLocation",
									"s3:GetObject",
									"s3:ListBucket",
									"s3:ListBucketMultipartUploads",
									"s3:PutObject"
								],
								"Resource":[
									"arn:aws:s3:::${stack}.log.sagebase.org",
									"arn:aws:s3:::${stack}.log.sagebase.org/*"
								]
							},
							{
								"Effect":"Allow",
								"Action": [
									"glue:GetTableVersions"
								],
								"Resource":[
									"*"
								]
							},
							{
								"Effect":"Allow",
								"Action":[
									"kms:Decrypt"
								],
								"Resource":[
									"*"
								]
							}
						]
					}
				}
			]
		}
	},
	"${stack}${instance}FirehoseLogs": {
		"Type":"AWS::Glue::Database",
		"Properties":{
			"CatalogId":{
				"Ref":"AWS::AccountId"
			},
			"DatabaseInput": {
				"Name": "${stack}${instance}FirehoseLogs"
			}
		}
	},
	#foreach( $stream in $kinesisFirehoseStreams)
	#if( $stream.convertToParquet )
	"${stack}${instance}${stream.name}Table": {
		"Type":"AWS::Glue::Table",
		"Properties": {
			"CatalogId": {
				"Ref":"AWS::AccountId"
			},
			"DatabaseName": {
				"Ref":"${stack}${instance}FirehoseLogs"
			},
			"TableInput": {
				"Name": "${stack}${instance}${stream.name}Table",
				"StorageDescriptor": {
					"Columns": [
						#foreach($column in $stream.tableDescriptor.columns.entrySet())
						{
							"Name":"${column.key}",
							"Type":"${column.value}"
						}
						#if( $foreach.hasNext),#end
						#end
					],
					"InputFormat": "org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat",
					"OutputFormat": "org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat",
					"Compressed": false,
					"SerdeInfo": {
						"SerializationLibrary": "org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe",
						"Parameters": {
							"serialization.format": "1"
						}
					},
					"Location": "s3://${stack}.log.sagebase.org/${stream.name}"
				},
				"PartitionKeys": [
					#foreach($partitionKey in $stream.tableDescriptor.partitionKeys.entrySet())
					{
						"Name":"${partitionKey.key}",
						"Type":"${partitionKey.value}"
					}
					#if( $foreach.hasNext),#end
					#end
				],
				"TableType": "EXTERNAL_TABLE"
			}
		}
	},
	#end
	#end
	#foreach( $stream in $kinesisFirehoseStreams)
	"${stream.name}KinesisStream":{
		"Type":"AWS::KinesisFirehose::DeliveryStream",
		"Properties":{
			"DeliveryStreamName":"${stack}${instance}${stream.name}",
			"DeliveryStreamType":"DirectPut",
			"ExtendedS3DestinationConfiguration":{
				"RoleARN":{
					"Fn::GetAtt":[
						"KinesisFirehoseLogRole",
						"Arn"
					]
				},
				"BucketARN":"arn:aws:s3:::${stack}.log.sagebase.org",
				"Prefix":"${stream.name}/${stream.partitionScheme}/",
				"ErrorOutputPrefix":"${stream.name}/errors/!{firehose:error-output-type}/!{timestamp:yyyy-MM-dd}/",
				#if( $stream.convertToParquet )
				"BufferingHints":{
					"IntervalInSeconds":"60",
					"SizeInMBs":"64"
				},
				"CompressionFormat":"UNCOMPRESSED",
				"DataFormatConversionConfiguration": {
					"SchemaConfiguration": {
						"CatalogId": {
							"Ref":"AWS::AccountId"
						},
						"RoleARN":{
							"Fn::GetAtt":[
								"KinesisFirehoseLogRole",
								"Arn"
							]
						},
						"DatabaseName": {
							"Ref":"${stack}${instance}FirehoseLogs"
						},
						"TableName": {
							"Ref":"${stack}${instance}${stream.name}Table"
						},
						"Region": {
							"Ref":"AWS::Region"
						},
						"VersionId":"LATEST"
					},
					"InputFormatConfiguration":{
						"Deserializer": {
							"OpenXJsonSerDe":{}
						}
					},
					"OutputFormatConfiguration":{
						"Serializer": {
							"ParquetSerDe":{}
						}
					},
					"Enabled": true
				},
				"S3BackupMode": "Enabled",
				"S3BackupConfiguration": {
					"RoleARN":{
						"Fn::GetAtt":[
							"KinesisFirehoseLogRole",
							"Arn"
						]
					},
					"BucketARN":"arn:aws:s3:::${stack}.log.sagebase.org",
					"BufferingHints":{
						"IntervalInSeconds":"60",
						"SizeInMBs":"64"
					},
					"CompressionFormat" : "GZIP",
					"Prefix":"${stream.name}Backup/${stream.partitionScheme}/",
					"ErrorOutputPrefix":"${stream.name}Backup/errors/!{firehose:error-output-type}/!{timestamp:yyyy-MM-dd}/"
				}
				#else
				"BufferingHints":{
					"IntervalInSeconds":"60",
					"SizeInMBs":"50"
				},
				"CompressionFormat":"GZIP"
				#end
			}
		}
	}
	#if( $foreach.hasNext) , #end
	#end
#end